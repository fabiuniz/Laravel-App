# ğŸš€ Laravel Docker App - CI/CD Pipeline para Google Cloud Run
# Autor: Fabiano Rocha/Fabiuniz
# DescriÃ§Ã£o: Pipeline completo com testes, build Docker e deploy automatizado

name: ğŸš€ Deploy Laravel to Google Cloud Run

on:
  push:
    branches:
      - main        # ğŸŒ ProduÃ§Ã£o
      - develop     # ğŸ§ª Staging
  pull_request:
    branches:
      - main
      - develop

# âš™ï¸ VariÃ¡veis de ambiente globais
env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: us-central1
  REPOSITORY: laravel-app
  SERVICE: laravel-docker-app
  REGION: us-central1

jobs:
  # 1ï¸âƒ£ JOB: Testes Automatizados
  tests:
    name: ğŸ§ª Executar Testes
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: laravel_test
          MYSQL_USER: laravel_user
          MYSQL_PASSWORD: laravel_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, mysql, pdo_mysql
          coverage: xdebug

      - name: ğŸ“¦ Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: ğŸ”§ Instalar dependÃªncias Composer
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: ğŸ“‹ Copiar arquivo de ambiente de teste
        run: |
          cp .env.example .env
          echo "DB_CONNECTION=mysql" >> .env
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_PORT=3306" >> .env
          echo "DB_DATABASE=laravel_test" >> .env
          echo "DB_USERNAME=laravel_user" >> .env
          echo "DB_PASSWORD=laravel_password" >> .env

      - name: ğŸ”‘ Gerar chave da aplicaÃ§Ã£o
        run: php artisan key:generate

      - name: ğŸ—„ï¸ Executar migraÃ§Ãµes
        run: php artisan migrate --force

      - name: âœ… Executar testes PHPUnit
        run: php artisan test --coverage

      - name: ğŸ“Š Executar verificaÃ§Ãµes de cÃ³digo
        run: |
          if [ -f ./vendor/bin/phpcs ]; then
            ./vendor/bin/phpcs --standard=PSR12 app/
          fi

  # 2ï¸âƒ£ JOB: Build e Deploy
  deploy:
    name: ğŸš€ Build e Deploy
    needs: tests
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    
    # ğŸŒ Matriz de ambientes
    strategy:
      matrix:
        include:
          - branch: main
            environment: production
            service_suffix: ""
            cloud_sql_instance: laravel-db-prod
            db_database_secret: DB_DATABASE
            db_username_secret: DB_USERNAME
            db_password_secret: DB_PASSWORD
          - branch: develop
            environment: staging
            service_suffix: "-staging"
            cloud_sql_instance: laravel-db-staging
            db_database_secret: DB_DATABASE_STAGING
            db_username_secret: DB_USERNAME_STAGING
            db_password_secret: DB_PASSWORD_STAGING

    # ğŸ”’ Filtrar por branch
    if: github.ref == format('refs/heads/{0}', matrix.branch)
    
    environment: ${{ matrix.environment }}

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Configurar autenticaÃ§Ã£o Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: âš™ï¸ Configurar Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸ³ Configurar Docker para Artifact Registry
        run: gcloud auth configure-docker $GAR_LOCATION-docker.pkg.dev

      - name: ğŸ—ï¸ Build da imagem Docker
        run: |
          docker build -t $GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$SERVICE${{ matrix.service_suffix }}:$GITHUB_SHA \
            --build-arg APP_ENV=${{ matrix.environment }} \
            --build-arg APP_DEBUG=false \
            .

      - name: ğŸ“¤ Push da imagem para Artifact Registry
        run: |
          docker push $GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$SERVICE${{ matrix.service_suffix }}:$GITHUB_SHA

      - name: ğŸš€ Deploy no Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE }}${{ matrix.service_suffix }}
          region: ${{ env.REGION }}
          image: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE }}${{ matrix.service_suffix }}:${{ github.sha }}
          flags: |
            --allow-unauthenticated
            --port=8000
            --memory=512Mi
            --cpu=1
            --min-instances=0
            --max-instances=10
            --concurrency=80
            --timeout=300
            --add-cloudsql-instances=${{ env.PROJECT_ID }}:${{ env.REGION }}:${{ matrix.cloud_sql_instance }}
            --set-env-vars="APP_ENV=${{ matrix.environment }}"
            --set-env-vars="APP_DEBUG=false"
            --set-env-vars="LOG_CHANNEL=stderr"
            --set-env-vars="DB_CONNECTION=mysql"
            --set-env-vars="DB_HOST=/cloudsql/${{ env.PROJECT_ID }}:${{ env.REGION }}:${{ matrix.cloud_sql_instance }}"
            --set-env-vars="DB_PORT=3306"
            --set-env-vars="DB_DATABASE=${{ secrets[matrix.db_database_secret] }}"
            --set-env-vars="DB_USERNAME=${{ secrets[matrix.db_username_secret] }}"
            --set-env-vars="DB_PASSWORD=${{ secrets[matrix.db_password_secret] }}"
            --set-env-vars="APP_KEY=${{ secrets.LARAVEL_APP_KEY }}"
            --set-env-vars="CACHE_DRIVER=file"
            --set-env-vars="SESSION_DRIVER=file"
            --set-env-vars="QUEUE_CONNECTION=sync"

      - name: ğŸ—„ï¸ Executar migraÃ§Ãµes via Cloud Run Job
        run: |
          gcloud run jobs create laravel-migrate-${{ matrix.environment }}-$GITHUB_SHA \
            --image=$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$SERVICE${{ matrix.service_suffix }}:$GITHUB_SHA \
            --region=$REGION \
            --add-cloudsql-instances=$PROJECT_ID:$REGION:${{ matrix.cloud_sql_instance }} \
            --set-env-vars="APP_ENV=${{ matrix.environment }}" \
            --set-env-vars="APP_DEBUG=false" \
            --set-env-vars="DB_CONNECTION=mysql" \
            --set-env-vars="DB_HOST=/cloudsql/$PROJECT_ID:$REGION:${{ matrix.cloud_sql_instance }}" \
            --set-env-vars="DB_PORT=3306" \
            --set-env-vars="DB_DATABASE=${{ secrets[matrix.db_database_secret] }}" \
            --set-env-vars="DB_USERNAME=${{ secrets[matrix.db_username_secret] }}" \
            --set-env-vars="DB_PASSWORD=${{ secrets[matrix.db_password_secret] }}" \
            --set-env-vars="APP_KEY=${{ secrets.LARAVEL_APP_KEY }}" \
            --command="php" \
            --args="artisan,migrate,--force" \
            --memory=256Mi \
            --cpu=0.5 \
            --max-retries=3 \
            --parallelism=1 \
            --task-timeout=600 \
            --replace

          # Executar o job de migraÃ§Ã£o
          gcloud run jobs execute laravel-migrate-${{ matrix.environment }}-$GITHUB_SHA --region=$REGION --wait

          # Limpar job apÃ³s execuÃ§Ã£o
          gcloud run jobs delete laravel-migrate-${{ matrix.environment }}-$GITHUB_SHA --region=$REGION --quiet

      - name: ğŸ§¹ OtimizaÃ§Ã£o pÃ³s-deploy
        run: |
          # Criar job para otimizaÃ§Ã£o do Laravel
          gcloud run jobs create laravel-optimize-${{ matrix.environment }}-$GITHUB_SHA \
            --image=$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$SERVICE${{ matrix.service_suffix }}:$GITHUB_SHA \
            --region=$REGION \
            --set-env-vars="APP_ENV=${{ matrix.environment }}" \
            --set-env-vars="APP_DEBUG=false" \
            --set-env-vars="APP_KEY=${{ secrets.LARAVEL_APP_KEY }}" \
            --command="/bin/bash" \
            --args="-c,php artisan config:cache && php artisan route:cache && php artisan view:cache" \
            --memory=256Mi \
            --cpu=0.5 \
            --max-retries=2 \
            --parallelism=1 \
            --task-timeout=300 \
            --replace

          # Executar otimizaÃ§Ã£o
          gcloud run jobs execute laravel-optimize-${{ matrix.environment }}-$GITHUB_SHA --region=$REGION --wait

          # Limpar job
          gcloud run jobs delete laravel-optimize-${{ matrix.environment }}-$GITHUB_SHA --region=$REGION --quiet

      - name: ğŸ” VerificaÃ§Ã£o de saÃºde
        run: |
          # Aguardar o serviÃ§o ficar disponÃ­vel
          sleep 30
          
          # Obter URL do serviÃ§o
          SERVICE_URL=$(gcloud run services describe $SERVICE${{ matrix.service_suffix }} --region=$REGION --format='value(status.url)')
          
          # Verificar saÃºde da aplicaÃ§Ã£o
          echo "ğŸ” Verificando saÃºde em: $SERVICE_URL"
          
          # Tentar conectar com retry
          for i in {1..5}; do
            if curl -f -s "$SERVICE_URL/api/hello" > /dev/null; then
              echo "âœ… AplicaÃ§Ã£o estÃ¡ respondendo!"
              break
            else
              echo "â³ Tentativa $i/5 falhou, aguardando 15s..."
              sleep 15
            fi
          done
          
          # Verificar se o endpoint principal estÃ¡ funcionando
          curl -f -s "$SERVICE_URL" > /dev/null || (echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ respondendo corretamente" && exit 1)
          
          echo "ğŸ‰ Deploy realizado com sucesso!"
          echo "ğŸŒ URL da aplicaÃ§Ã£o: $SERVICE_URL"

      - name: ğŸ§¹ Limpeza de imagens antigas
        if: success()
        run: |
          # Manter apenas as 5 imagens mais recentes
          gcloud artifacts docker images list $GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$SERVICE${{ matrix.service_suffix }} \
            --sort-by="~CREATE_TIME" \
            --limit=999 \
            --format="get(version)" | tail -n +6 | while read version; do
            if [ ! -z "$version" ]; then
              echo "ğŸ—‘ï¸ Removendo imagem antiga: $version"
              gcloud artifacts docker images delete \
                $GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$SERVICE${{ matrix.service_suffix }}:$version \
                --quiet
            fi
          done || echo "â„¹ï¸ Nenhuma imagem antiga para remover"

  # 3ï¸âƒ£ JOB: NotificaÃ§Ã£o de Deploy
  notify:
    name: ğŸ“¢ Notificar Resultado
    needs: [tests, deploy]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“Š Preparar status do deploy
        id: status
        run: |
          if [ "${{ needs.tests.result }}" == "success" ] && [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… Deploy realizado com sucesso!" >> $GITHUB_OUTPUT
            echo "color=28a745" >> $GITHUB_OUTPUT
          elif [ "${{ needs.tests.result }}" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Falha nos testes automatizados" >> $GITHUB_OUTPUT
            echo "color=dc3545" >> $GITHUB_OUTPUT
          elif [ "${{ needs.deploy.result }}" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Falha no deploy" >> $GITHUB_OUTPUT
            echo "color=dc3545" >> $GITHUB_OUTPUT
          else
            echo "status=cancelled" >> $GITHUB_OUTPUT
            echo "message=âš ï¸ Deploy cancelado" >> $GITHUB_OUTPUT
            echo "color=ffc107" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Resumo do deploy
        run: |
          echo "## ğŸš€ Resultado do Deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.status.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.status.outputs.status }}" == "success" ]; then
            if [ "${{ github.ref_name }}" == "main" ]; then
              echo "ğŸŒ **ProduÃ§Ã£o:** https://${{ env.SERVICE }}-xxxxx-uc.a.run.app" >> $GITHUB_STEP_SUMMARY
            else
              echo "ğŸ§ª **Staging:** https://${{ env.SERVICE }}-staging-xxxxx-uc.a.run.app" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Jobs Executados" >> $GITHUB_STEP_SUMMARY
          echo "- **Testes:** ${{ needs.tests.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy:** ${{ needs.deploy.result == 'success' && 'âœ…' || needs.deploy.result == 'failure' && 'âŒ' || 'â­ï¸' }} ${{ needs.deploy.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY

# ğŸ“‹ ConfiguraÃ§Ãµes de seguranÃ§a
permissions:
  contents: read
  id-token: write
  actions: read
  checks: write

# ğŸ”„ ConfiguraÃ§Ãµes de concorrÃªncia
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false